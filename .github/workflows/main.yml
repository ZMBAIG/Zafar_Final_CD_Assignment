name: Github actions Repository

on: push
jobs:
  checkout-repository:
    runs-on: ubuntu-20.04
    steps:
    
      - name: Checkout repository
        uses: actions/checkout@v2
    
      - name: Setup Python
        uses: actions/setup-python@v2
       
        with:
          python-version: '3.8.6'
      # Install PyTest and Flask
      - name: Install Dependencies
        run: pip install -r requirements.txt
      # Run the tests
      - name: Run tests
        run: pytest
     
#       - name: Add SSH key
#         uses: shimataro/ssh-key-action@v2
#         with:
#           key: ${{ secrets.SSH_PRIVATE_KEY }} 
#           known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
      
#       - name: Adding known hosts
#         run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
     
# #       - name: Deploy with Rsync
# #         run: rsync -avz ./dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/winc-final-asignment/
# #       # Restart the application
# #       - name: Restart Application
# #         run: ssh -t ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'Pseudo systemctl restart winc-final-asignment'

      - name: Copy repository contents to vps via scp
        uses: appleboy/scp-action@master
        env:
          HOST: '${{ secrets.SSH_HOST }}'
          USERNAME: '${{ secrets.SSH_USER }}'
          PORT: '${{ secrets.PORT }}'
          KEY: '${{ secrets.SSH_PRIVATE_KEY }}'
        with:
          source: .
          target: /home/Zafar_Final_CD_Assignment-01/
          
      - name: Executing remote command
        uses: appleboy/ssh-action@master
        with:
          host: '${{ secrets.SSH_HOST }}'
          USERNAME: '${{ secrets.SSH_USER }}'
          PORT: '${{ secrets.PORT }}'
          KEY: '${{ secrets.SSH_PRIVATE_KEY }}'
          script: sh /home/Zafar_Final_CD_Assignment-01/commands.sh

